<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Navi3 - Kamyon Navigasyon</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- HERE Maps API -->
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    
    <style>
        body, html {
            height: 100%;
            margin: 0;
            background-color: #f8f9fa;
            overflow: hidden;
        }
        #login-view {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        #app-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }
        #split-container {
            display: flex;
            flex-direction: row;
            height: 100%;
        }
        .split-pane {
            overflow-y: auto;
            background-color: #fff;
        }
        #pane-controls, #pane-pallets {
             padding: 1rem;
        }
        #pane-map {
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .gutter {
            background-color: #eee;
            background-repeat: no-repeat;
            background-position: 50%;
        }
        .gutter.gutter-horizontal {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAeCAYAAADkftS9AAAAIklEQVQoU2M4c+bM/5+BgYkBgYwBiFhYWIgimAhYiAIAVcsY2803V6EAAAAASUVORK5CYII=');
            cursor: col-resize;
        }
    </style>
</head>
<body>
    <!-- GİRİŞ EKRANI -->
    <div id="login-view">
        <div class="card shadow-sm" style="width: 350px;">
            <div class="card-body p-4">
                <h3 class="card-title text-center mb-4">Navi3 Giriş</h3>
                <div class="mb-3">
                    <label for="username" class="form-label">Kullanıcı Adı</label>
                    <input type="text" class="form-control" id="username" value="admin">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Şifre</label>
                    <input type="password" class="form-control" id="password" value="admin123">
                </div>
                <div class="d-grid">
                    <button id="login-button" class="btn btn-primary">Giriş Yap</button>
                </div>
                <p id="login-error" class="text-danger mt-3 text-center"></p>
            </div>
        </div>
    </div>

    <!-- ANA UYGULAMA EKRANI -->
    <div id="app-container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm flex-shrink-0">
             <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-truck-front-fill"></i> Navi3
                </a>
                <button id="show-driver-management-button" class="btn btn-outline-light">Şoför Yönetimi</button>
            </div>
        </nav>

        <main id="split-container" class="flex-grow-1">
            <!-- KONTROL PANELİ -->
            <div id="pane-controls" class="split-pane">
                <div id="main-panel-view">
                    <h4 class="border-bottom pb-2 mb-3">Kontrol Paneli</h4>
                    <div class="mb-3">
                        <label for="driver-select" class="form-label fw-bold">Şoför Seç</label>
                        <select id="driver-select" class="form-select">
                            <option value="" selected>Şoför seçilmedi</option>
                        </select>
                    </div>
                    <div id="market-selection-area" class="card card-body mb-4">
                        <div class="mb-3">
                            <label for="city-search" class="form-label fw-bold">1. Şehir Adı ile Ara</label>
                            <input type="text" id="city-search" class="form-control" placeholder="Örn: Essen">
                        </div>
                        <div class="mb-3">
                            <label for="market-name-search" class="form-label fw-bold">2. Market Adı ile Ara</label>
                            <input type="text" id="market-name-search" class="form-control" placeholder="Örn: Dünya Market">
                        </div>
                        <div id="city-based-markets" class="mb-3" style="max-height: 200px; overflow-y: auto;"></div>
                        <div class="d-grid">
                            <button id="add-selected-markets-button" class="btn btn-info">Seçilen Marketleri Ekle</button>
                        </div>
                    </div>
                    <div id="pallet-entry-area" class="card card-body bg-light">
                        <h5 class="border-bottom pb-2 mb-3">Rota ve Palet Bilgileri</h5>
                        <ul id="final-market-list" class="list-group mb-3 border border-dark"></ul>
                    </div>
                    <div class="d-grid mt-4">
                        <button id="routeButton" class="btn btn-primary btn-lg"><i class="bi bi-geo-alt-fill"></i> Rota Oluştur</button>
                    </div>
                    <div id="notification" class="alert mt-3" style="display: none;"></div>
                    <div id="info-panel" class="mt-3 pt-3 border-top">
                        <h5>Rota Bilgileri</h5>
                        <p><strong>Toplam Palet:</strong> <span id="total-pallets">0</span></p>
                        <p><strong>Mesafe:</strong> <span id="distance">--</span> km</p>
                        <p><strong>Süre:</strong> <span id="travel-time">--</span></p>
                    </div>

                    <!-- BAŞLANGIÇ/BİTİŞ VE TONAJ KONTROLLERİ -->
                    <div class="mt-4 pt-3 border-top">
                        <h5 class="mb-3">Rota Detayları</h5>
                        <div class="mb-3">
                            <label for="start" class="form-label fw-bold">Başlangıç Noktası</label>
                            <select id="start" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label for="end" class="form-label fw-bold">Bitiş Noktası</label>
                            <select id="end" class="form-select"></select>
                        </div>
                        <div class="mb-3">
                            <label for="weight" class="form-label">Kamyon Tonajı (kg)</label>
                            <input type="number" id="weight" class="form-control" value="25000" min="0">
                        </div>
                    </div>
                </div>
                <div id="driver-management-view" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                        <h4>Şoför Yönetimi</h4>
                        <button id="back-to-main-button" class="btn btn-sm btn-outline-secondary">Geri Dön</button>
                    </div>
                    <form id="add-driver-form">
                        <h6>Yeni Şoför Ekle</h6>
                        <div class="mb-2"><input type="text" id="driver-name" class="form-control" placeholder="Şoför Adı" required></div>
                        <div class="mb-2"><input type="text" id="driver-plate" class="form-control" placeholder="Kamyon Plakası" required></div>
                        <div class="mb-2"><input type="number" id="driver-max-pallets" class="form-control" value="34" min="0" required placeholder="Maks. Palet"></div>
                        <div class="mb-2"><input type="text" id="driver-fixed-start" class="form-control" placeholder="Sabit Çıkış Adresi" required></div>
                        <div class="mb-2"><input type="text" id="driver-fixed-end" class="form-control" placeholder="Sabit Varış Adresi" required></div>
                        <div class="d-grid"><button type="submit" class="btn btn-success">Şoför Ekle</button></div>
                    </form>
                    <hr>
                    <h6>Mevcut Şoförler</h6>
                    <ul id="driver-list" class="list-group"></ul>
                </div>
            </div>

            <!-- HARİTA PANELİ -->
            <div id="pane-map" class="split-pane">
                <div class="h-100 w-100" id="map"></div>
            </div>

            <!-- PALET YÜKLEME SİSTEMİ PANELİ -->
            <div id="pane-pallets" class="split-pane">
                <h5 class="border-bottom pb-2 mb-3">Palet Yükleme Sistemi</h5>
            </div>
        </main>
    </div>

    <!-- JS KÜTÜPHANELERİ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/split.js/dist/split.min.js"></script>

    <!-- ANA UYGULAMA SCRİPTİ -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // --- GLOBAL DEĞİŞKENLER ---
        const HERE_API_KEY = 'rnWVc4gACUg-4DhRlWTVainI7ihE6tx1vcHTMhdqXuI';
        const platform = new H.service.Platform({ apikey: HERE_API_KEY });
        const defaultLayers = platform.createDefaultLayers();
        let map = null;
        let ui = null;
        let allMarkets = [];
        let selectedRouteMarkets = [];
        let sortable = null;
        let allDrivers = []; // Şoför verilerini saklamak için yeni değişken

        // --- DOM ELEMENTLERİ ---
        const loginView = document.getElementById('login-view');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');

        // --- GİRİŞ İŞLEMLERİ ---
        loginButton.addEventListener('click', async () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            
            try {
                const response = await fetch('http://localhost:3000/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    loginView.style.display = 'none';
                    appContainer.style.display = 'flex';
                    initializeApp();
                } else {
                    loginError.textContent = data.message || 'Giriş başarısız.';
                }
            } catch (error) {
                loginError.textContent = 'Sunucuya bağlanılamadı.';
            }
        });

        // --- UYGULAMA BAŞLATMA ---
        function initializeApp() {
            // 3'lü panel yapısını Split.js ile oluştur
            Split(['#pane-controls', '#pane-map', '#pane-pallets'], {
                sizes: [30, 45, 25],
                minSize: [350, 300, 250],
                gutterSize: 8,
                cursor: 'col-resize',
                onDragEnd: () => {
                    if (map) map.getViewPort().resize();
                }
            });

            map = new H.Map(
                document.getElementById('map'),
                defaultLayers.vector.normal.map,
                { zoom: 6, center: { lat: 51.1657, lng: 10.4515 } }
            );
            const behavior = new H.mapevents.Behavior(new H.mapevents.MapEvents(map));
            ui = H.ui.UI.createDefault(map, defaultLayers);

            loadInitialData();
            populateStartEndLocations(); // Başlangıç/Bitiş noktalarını doldur
            addEventListeners();
        }

        // Başlangıç ve bitiş noktalarını doldurur
        function populateStartEndLocations() {
            const startSelect = document.getElementById('start');
            const endSelect = document.getElementById('end');
            const locations = [
                { text: "Willy-Brandt-Straße 1, Berlin", value: "52.5186,13.3761" },
                { text: "Rathausmarkt 1, Hamburg", value: "53.5504,9.9925" },
                { text: "Marienplatz 1, München", value: "48.1371,11.5753" },
                { text: "Domkloster 4, Köln", value: "50.9413,6.9583" },
                { text: "Römerberg 23, Frankfurt", value: "50.1109,8.6821" }
            ];
            locations.forEach(loc => {
                startSelect.add(new Option(loc.text, loc.value));
                endSelect.add(new Option(loc.text, loc.value));
            });
        }

        // --- OLAY DİNLEYİCİLERİNİ EKLEME ---
        function addEventListeners() {
            // Panel geçiş butonları
            document.getElementById('show-driver-management-button').addEventListener('click', showDriverManagementView);
            document.getElementById('back-to-main-button').addEventListener('click', showMainPanelView);

            // Ana panel dinleyicileri
            document.getElementById('city-search').addEventListener('input', handleCitySearch);
            document.getElementById('market-name-search').addEventListener('input', handleMarketNameSearch);
            document.getElementById('add-selected-markets-button').addEventListener('click', handleAddSelectedMarkets);
            document.getElementById('routeButton').addEventListener('click', handleRouteCalculation);

            // Şoför yönetimi dinleyicileri
            document.getElementById('add-driver-form').addEventListener('submit', handleAddDriver);

            document.getElementById('driver-select').addEventListener('change', handleDriverSelection);
        }

        // --- ROTA HESAPLAMA İŞLEMLERİ ---
        async function handleRouteCalculation() {
            const startPoint = document.getElementById('start').value;
            const endPoint = document.getElementById('end').value;
            const truckWeight = parseInt(document.getElementById('weight').value, 10);

            // Seçilen marketlerin ID ve koordinatlarını al
            const viaPointsData = selectedRouteMarkets.map(market => ({
                id: market.id, // Firestore ID'sini ekliyoruz
                lat: market.coordinates.lat,
                lng: market.coordinates.lng
            }));

            if (!startPoint || !endPoint || viaPointsData.length === 0) {
                showNotification('Lütfen başlangıç, bitiş ve en az bir ara nokta seçin.', 'error');
                return;
            }

            try {
                const optimizeResponse = await fetch(`http://localhost:3000/api/optimize-route`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        origin: startPoint, 
                        destination: endPoint, 
                        viaPoints: viaPointsData, 
                        truckSpecs: { maxWeight: truckWeight } 
                    })
                });

                const optimizeData = await optimizeResponse.json();

                if (optimizeResponse.ok && optimizeData.success) {
                    showNotification('Sıralama optimize edildi, detaylı rota alınıyor...', 'info');

                    // 2. ADIM: Optimize edilmiş sıralama ile detaylı rotayı al
                    const detailedRouteResponse = await fetch('http://localhost:3000/api/detailed-route', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            waypoints: optimizeData.optimizedSequence, // Optimize edilmiş sıralamayı gönder
                            truckSpecs: { maxWeight: truckWeight }
                        })
                    });

                    const detailedRouteData = await detailedRouteResponse.json();

                    if (detailedRouteResponse.ok && detailedRouteData.success) {
                        showNotification('Rota başarıyla oluşturuldu!', 'success');

                        try {
                            // --- HARİTA GÜNCELLEME BAŞLANGIÇ ---
                            
                            if (!detailedRouteData.route || !detailedRouteData.route.polylines || detailedRouteData.route.polylines.length === 0) {
                                throw new Error('Sunucudan geçerli bir rota çizim verisi (polylines) gelmedi.');
                            }

                            // Haritayı temizle
                            map.removeObjects(map.getObjects());

                            // 1. Rota sınırlarını (bounds) manuel olarak hesapla
                            let minLat = Infinity, maxLat = -Infinity;
                            let minLng = Infinity, maxLng = -Infinity;

                            optimizeData.optimizedSequence.forEach(point => {
                                minLat = Math.min(minLat, point.lat);
                                maxLat = Math.max(maxLat, point.lat);
                                minLng = Math.min(minLng, point.lng);
                                maxLng = Math.max(maxLng, point.lng);
                            });

                            const boundingBox = new H.geo.Rect(minLat, minLng, maxLat, maxLng);
                            

                            // 2. Detaylı rota geometrilerini haritaya çiz
                            detailedRouteData.route.polylines.forEach(polylineStr => {
                                const detailedRouteGeometry = H.geo.LineString.fromFlexiblePolyline(polylineStr);
                                if (detailedRouteGeometry) {
                                    const routeLine = new H.map.Polyline(detailedRouteGeometry, { style: { lineWidth: 8, strokeColor: 'rgba(0, 128, 255, 0.7)' } });
                                    map.addObject(routeLine);
                                }
                            });

                            const startMarker = new H.map.Marker(new H.geo.Point(optimizeData.optimizedSequence[0].lat, optimizeData.optimizedSequence[0].lng));
                            const endMarker = new H.map.Marker(new H.geo.Point(optimizeData.optimizedSequence[optimizeData.optimizedSequence.length - 1].lat, optimizeData.optimizedSequence[optimizeData.optimizedSequence.length - 1].lng));

                            // Ara duraklar için işaretçiler ekle
                            const intermediateMarkers = optimizeData.optimizedSequence
                                .filter((point, index) => index !== 0 && index !== optimizeData.optimizedSequence.length - 1)
                                .map(point => new H.map.Marker(new H.geo.Point(point.lat, point.lng)));

                            map.addObjects([startMarker, endMarker, ...intermediateMarkers]);

                            // Hata ayıklama için optimize edilmiş diziyi sayfaya yazdır
                            const debugDiv = document.createElement('div');
                            debugDiv.id = 'debug-optimized-sequence';
                            debugDiv.style.whiteSpace = 'pre-wrap';
                            debugDiv.style.fontFamily = 'monospace';
                            debugDiv.style.backgroundColor = '#f0f0f0';
                            debugDiv.style.padding = '10px';
                            debugDiv.style.margin = '10px 0';
                            debugDiv.textContent = "Optimize Edilmiş Dizi (Debug):\n" + JSON.stringify(optimizeData.optimizedSequence, null, 2);
                            document.body.appendChild(debugDiv);

                            // 3. Haritayı daha önce hesaplanan sınırlara sığdır
                            if (boundingBox) {
                                map.getViewModel().setLookAtData({ bbox: boundingBox });
                            } else {
                                console.warn("Geçerli bir sınır kutusu (boundingBox) bulunamadı, harita görünümü ayarlanamadı.");
                            }

                            // --- LİSTE VE BİLGİ PANELİ GÜNCELLEME ---
                            const reorderedMarkets = optimizeData.optimizedSequence
                                .filter(wp => wp.id !== 'start' && wp.id !== 'end')
                                .map(wp => selectedRouteMarkets.find(m => m.id === wp.id));
                            selectedRouteMarkets = reorderedMarkets.filter(Boolean);
                            renderFinalMarketList();

                            document.getElementById('distance').textContent = `${optimizeData.summary.totalDistanceKm.toFixed(2)} km`;
                            document.getElementById('travel-time').textContent = `${optimizeData.summary.totalTimeHours.toFixed(2)} saat`;

                        } catch (e) {
                            console.error("Harita çizim hatası:", e);
                            showNotification(`Harita çizilirken bir hata oluştu: ${e.message}`, 'error');
                        }

                    } else {
                        showNotification(`Detaylı rota alınamadı: ${detailedRouteData.message || 'Bilinmeyen hata'}`, 'error');
                    }
                } else {
                    showNotification(`Rota optimizasyonu başarısız: ${optimizeData.message || 'Bilinmeyen hata'}`, 'error');
                }
            } catch (error) {
                showNotification("Rota optimizasyonu sırasında sunucuya bağlanılamadı.", 'error');
            }
        }

        // --- GÖRÜNÜM YÖNETİMİ ---
        function showMainPanelView() {
            document.getElementById('main-panel-view').style.display = 'block';
            document.getElementById('driver-management-view').style.display = 'none';
        }

        function showDriverManagementView() {
            document.getElementById('main-panel-view').style.display = 'none';
            document.getElementById('driver-management-view').style.display = 'block';
            loadDrivers(); // Görünüme geçildiğinde şoförleri yükle
        }

        // --- VERİ YÜKLEME ---
        async function loadInitialData() {
            try {
                const response = await fetch('http://localhost:3000/api/markets');
                if (!response.ok) throw new Error('Marketler yüklenemedi.');
                allMarkets = await response.json();
                await loadDrivers(); // Başlangıçta şoförleri de yükle
            } catch (error) {
                showNotification(error.message, "error");
            }
        }

        async function loadDrivers() {
            try {
                const response = await fetch('http://localhost:3000/api/drivers');
                if (!response.ok) throw new Error('Şoförler yüklenemedi.');
                const drivers = await response.json();
                allDrivers = drivers; // Şoför verilerini global değişkene ata
                
                const driverSelect = document.getElementById('driver-select');
                const driverList = document.getElementById('driver-list');
                
                // Mevcut seçenekleri ve listeyi temizle
                driverSelect.innerHTML = '<option value="" selected>Şoför seçilmedi</option>';
                driverList.innerHTML = '';

                drivers.forEach(driver => {
                    // Açılır menüye ekle
                    const option = new Option(`${driver.name} (${driver.licensePlate})`, driver.id);
                    driverSelect.add(option);

                    // Listeye ekle
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                    listItem.innerHTML = `
                        <span>
                            <strong>${driver.name}</strong> <small class="text-muted">(${driver.licensePlate})</small>
                        </span>
                        <button class="btn btn-sm btn-outline-danger delete-driver-btn" data-id="${driver.id}"><i class="bi bi-trash"></i></button>
                    `;
                    driverList.appendChild(listItem);
                });

                // Silme butonlarına olay dinleyicileri ekle
                document.querySelectorAll('.delete-driver-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteDriver);
                });

            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // --- ŞOFÖR YÖNETİMİ İŞLEMLERİ ---
        async function handleAddDriver(event) {
            event.preventDefault();
            const form = event.target;
            const driverData = {
                name: form.querySelector('#driver-name').value,
                licensePlate: form.querySelector('#driver-plate').value,
                maxPallets: form.querySelector('#driver-max-pallets').value,
                fixedStartAddress: form.querySelector('#driver-fixed-start').value,
                fixedEndAddress: form.querySelector('#driver-fixed-end').value,
            };

            try {
                const response = await fetch('http://localhost:3000/api/drivers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(driverData)
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.message || 'Şoför eklenemedi.');
                }
                showNotification('Şoför başarıyla eklendi!', 'success');
                form.reset();
                loadDrivers(); // Listeyi yenile
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function handleDriverSelection() {
            const driverId = document.getElementById('driver-select').value;
            const startSelect = document.getElementById('start');
            const endSelect = document.getElementById('end');

            // Dropdown'ları temizle (sadece varsayılan seçenekleri bırak)
            startSelect.innerHTML = '';
            endSelect.innerHTML = '';

            if (driverId) {
                const selectedDriver = allDrivers.find(driver => driver.id === driverId);
                if (selectedDriver) {
                    // Başlangıç adresini ekle
                    const startOption = new Option(selectedDriver.fixedStart.address, `${selectedDriver.fixedStart.coordinates.lat},${selectedDriver.fixedStart.coordinates.lng}`);
                    startSelect.add(startOption);
                    startSelect.value = `${selectedDriver.fixedStart.coordinates.lat},${selectedDriver.fixedStart.coordinates.lng}`;

                    // Bitiş adresini ekle
                    const endOption = new Option(selectedDriver.fixedEnd.address, `${selectedDriver.fixedEnd.coordinates.lat},${selectedDriver.fixedEnd.coordinates.lng}`);
                    endSelect.add(endOption);
                    endSelect.value = `${selectedDriver.fixedEnd.coordinates.lat},${selectedDriver.fixedEnd.coordinates.lng}`;
                }
            } else {
                // Şoför seçilmediyse varsayılan lokasyonları tekrar doldur
                populateStartEndLocations();
            }
        }

        async function handleDeleteDriver(event) {
            const driverId = event.currentTarget.dataset.id;
            if (confirm('Bu şoförü silmek istediğinizden emin misiniz?')) {
                try {
                    const response = await fetch(`http://localhost:3000/api/drivers/${driverId}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Şoför silinemedi.');
                    showNotification('Şoför başarıyla silindi.', 'success');
                    loadDrivers(); // Listeyi yenile
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            }
        }

        // --- MARKET SEÇİM FONKSİYONLARI ---
        function displayFilteredMarkets(filtered) {
            const container = document.getElementById('city-based-markets');
            container.innerHTML = filtered.map(market => {
                const isSelected = selectedRouteMarkets.some(m => m.id === market.id);
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${market.id}" id="market-${market.id}" ${isSelected ? 'disabled checked' : ''}>
                        <label class="form-check-label" for="market-${market.id}">${market.name} (${market.address})</label>
                    </div>`;
            }).join('');
        }

        function handleCitySearch(e) {
            document.getElementById('market-name-search').value = '';
            const term = e.target.value.toLowerCase();
            displayFilteredMarkets(term ? allMarkets.filter(m => m.city.toLowerCase().includes(term)) : []);
        }

        function handleMarketNameSearch(e) {
            document.getElementById('city-search').value = '';
            const term = e.target.value.toLowerCase();
            displayFilteredMarkets(term ? allMarkets.filter(m => m.name.toLowerCase().includes(term)) : []);
        }

        function handleAddSelectedMarkets() {
            document.querySelectorAll('#city-based-markets .form-check-input:checked:not(:disabled)').forEach(box => {
                const market = allMarkets.find(m => m.id === box.value);
                if (market) {
                    selectedRouteMarkets.push({ ...market, euroPallets: 1, widePallets: 0 });
                }
            });
            renderFinalMarketList();
            document.getElementById('city-search').value = '';
            document.getElementById('market-name-search').value = '';
            displayFilteredMarkets([]);
        }

        function renderFinalMarketList() {
            const container = document.getElementById('final-market-list');
            container.innerHTML = '';
            selectedRouteMarkets.forEach((market, index) => {
                const item = document.createElement('li');
                item.className = 'list-group-item';
                item.dataset.id = market.id;
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center flex-grow-1">
                            <i class="bi bi-grip-vertical text-muted me-2" style="cursor: grab;"></i>
                            <div class="flex-grow-1">
                                <strong>${index + 1}. ${market.name}</strong>
                                <small class="d-block text-muted">${market.address}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-danger remove-final-market-btn" data-id="${market.id}"><i class="bi bi-x-lg"></i></button>
                    </div>
                    <div class="row gx-2 align-items-center">
                        <div class="col"><div class="input-group input-group-sm"><span class="input-group-text">E</span><input type="number" class="form-control pallet-input" data-id="${market.id}" data-type="euro" value="${market.euroPallets}" min="0"></div></div>
                        <div class="col"><div class="input-group input-group-sm"><span class="input-group-text">G</span><input type="number" class="form-control pallet-input" data-id="${market.id}" data-type="wide" value="${market.widePallets}" min="0"></div></div>
                    </div>`;
                container.appendChild(item);
            });
            addFinalListListeners();
            updateTotalPallets();
            activateSorting();
        }

        function addFinalListListeners() {
            document.querySelectorAll('.pallet-input').forEach(i => i.addEventListener('change', handlePalletChange));
            document.querySelectorAll('.remove-final-market-btn').forEach(b => b.addEventListener('click', handleRemoveFinalMarket));
        }

        function handlePalletChange(e) {
            const market = selectedRouteMarkets.find(m => m.id === e.target.dataset.id);
            if(market) market[e.target.dataset.type === 'euro' ? 'euroPallets' : 'widePallets'] = parseInt(e.target.value, 10);
            updateTotalPallets();
        }

        function handleRemoveFinalMarket(e) {
            selectedRouteMarkets = selectedRouteMarkets.filter(m => m.id !== e.currentTarget.dataset.id);
            renderFinalMarketList();
        }

        function updateTotalPallets() {
            const totals = selectedRouteMarkets.reduce((acc, m) => {
                acc.euro += m.euroPallets || 0;
                acc.wide += m.widePallets || 0;
                return acc;
            }, { euro: 0, wide: 0 });
            document.getElementById('total-pallets').innerHTML = `${totals.euro} + <span class="text-danger fw-bold">${totals.wide}</span>`;
        }

        function activateSorting() {
            const list = document.getElementById('final-market-list');
            if (sortable) sortable.destroy();
            sortable = new Sortable(list, {
                animation: 150,
                ghostClass: 'bg-info-subtle',
                onEnd: (evt) => {
                    const item = selectedRouteMarkets.splice(evt.oldIndex, 1)[0];
                    selectedRouteMarkets.splice(evt.newIndex, 0, item);
                    renderFinalMarketList();
                }
            });
        }

        // --- YARDIMCI FONKSİYONLAR ---
        function showNotification(message, type) {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.className = `alert alert-${type === 'error' ? 'danger' : 'success'}`;
            el.style.display = 'block';
        }
    });
    </script>
</body>
</html>
